# ğŸ¨ OHM Database Visual Guide

Visual representation of how data flows through the OHM database.

---

## ğŸ“ Database Entity Relationship Diagram (ERD)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   auth.users    â”‚ (Supabase built-in)
â”‚  (Authentication)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:1
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           PROFILES                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ id (PK, FK â†’ auth.users)            â”‚
â”‚  â€¢ username                             â”‚
â”‚  â€¢ preferences (JSONB)                  â”‚
â”‚  â€¢ total_chats, total_projects         â”‚
â”‚  â€¢ subscription_tier                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ 1:N
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           CHATS                     â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
    â”‚  â€¢ id (PK) â† UUID for URL          â”‚
    â”‚  â€¢ user_id (FK â†’ profiles)         â”‚
    â”‚  â€¢ project_id (FK â†’ projects)      â”‚
    â”‚  â€¢ title (auto-generated)          â”‚
    â”‚  â€¢ current_phase                   â”‚
    â”‚  â€¢ is_public, share_token          â”‚
    â”‚  â€¢ mission_statement               â”‚
    â”‚  â€¢ total_messages                  â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚
        â”‚ 1:N         â”‚ 1:N
        â”‚             â”‚
        â†“             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MESSAGES    â”‚   â”‚     ARTIFACTS        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ id (PK)    â”‚   â”‚  â€¢ id (PK)           â”‚
â”‚  â€¢ chat_id    â”‚   â”‚  â€¢ chat_id           â”‚
â”‚  â€¢ role       â”‚   â”‚  â€¢ type (enum)       â”‚
â”‚  â€¢ content    â”‚   â”‚  â€¢ current_version   â”‚
â”‚  â€¢ agent_name â”‚   â”‚  â€¢ total_versions    â”‚
â”‚  â€¢ agent_modelâ”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ intent     â”‚          â”‚
â”‚  â€¢ tokens     â”‚          â”‚ 1:N
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                           â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   ARTIFACT_VERSIONS      â”‚
                  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
                  â”‚  â€¢ id (PK)               â”‚
                  â”‚  â€¢ artifact_id (FK)      â”‚
                  â”‚  â€¢ version_number        â”‚
                  â”‚  â€¢ content (text)        â”‚
                  â”‚  â€¢ content_json (JSONB)  â”‚
                  â”‚  â€¢ parent_version_id     â”‚
                  â”‚  â€¢ change_summary        â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           PROJECTS                  â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
    â”‚  â€¢ id (PK)                          â”‚
    â”‚  â€¢ user_id (FK â†’ profiles)          â”‚
    â”‚  â€¢ primary_chat_id (FK â†’ chats)     â”‚
    â”‚  â€¢ name, description                â”‚
    â”‚  â€¢ goal, location, budget           â”‚
    â”‚  â€¢ workflow_steps (JSONB)           â”‚
    â”‚  â€¢ status                           â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚           â”‚
        â”‚ 1:N        â”‚ 1:N       â”‚ 1:N
        â”‚            â”‚           â”‚
        â†“            â†“           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PARTS    â”‚  â”‚ CONNECTIONS â”‚  â”‚  CODE_FILES   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ id      â”‚  â”‚  â€¢ id       â”‚  â”‚  â€¢ id         â”‚
â”‚  â€¢ proj_id â”‚  â”‚  â€¢ proj_id  â”‚  â”‚  â€¢ proj_id    â”‚
â”‚  â€¢ name    â”‚  â”‚  â€¢ from_partâ”‚  â”‚  â€¢ filename   â”‚
â”‚  â€¢ voltage â”‚  â”‚  â€¢ from_pin â”‚  â”‚  â€¢ language   â”‚
â”‚  â€¢ price   â”‚  â”‚  â€¢ to_part  â”‚  â”‚  â€¢ content    â”‚
â”‚  â€¢ specs   â”‚  â”‚  â€¢ to_pin   â”‚  â”‚  â€¢ unit_num   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â€¢ wire_col â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CIRCUIT_VERIFICATIONS       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ id (PK)                       â”‚
â”‚  â€¢ chat_id (FK)                  â”‚
â”‚  â€¢ image_url                     â”‚
â”‚  â€¢ status (PASS/FAIL/WARNING)    â”‚
â”‚  â€¢ components_detected (JSONB)   â”‚
â”‚  â€¢ issues[], suggestions[]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      DATASHEET_ANALYSES          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ id (PK)                       â”‚
â”‚  â€¢ chat_id (FK)                  â”‚
â”‚  â€¢ file_url                      â”‚
â”‚  â€¢ component_name                â”‚
â”‚  â€¢ key_specs (JSONB)             â”‚
â”‚  â€¢ warnings[]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ATTACHMENTS              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ id (PK)                       â”‚
â”‚  â€¢ chat_id (FK), message_id (FK) â”‚
â”‚  â€¢ filename, file_type           â”‚
â”‚  â€¢ storage_path                  â”‚
â”‚  â€¢ category                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        SHARED_CHATS              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ id (PK)                       â”‚
â”‚  â€¢ chat_id (FK) UNIQUE           â”‚
â”‚  â€¢ share_token UNIQUE            â”‚
â”‚  â€¢ view_count, fork_count        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow: Complete User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USER OPENS OHM APP                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Load Recent Chats            â”‚
         â”‚  SELECT * FROM chats          â”‚
         â”‚  WHERE user_id = 'xxx'        â”‚
         â”‚  ORDER BY last_message_at     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  User Clicks "New Chat"       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  CREATE NEW CHAT                                  â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
         â”‚  INSERT INTO chats (user_id, title)              â”‚
         â”‚  VALUES ('user-123', 'New Hardware Project')     â”‚
         â”‚  RETURNING id;                                   â”‚
         â”‚                                                   â”‚
         â”‚  â†’ Returns: chat_id = 550e8400-...              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  NAVIGATE TO /chat/550e8400-...                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  User: "Build ESP32 weather   â”‚
         â”‚         station for $50"      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  STORE USER MESSAGE                              â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
         â”‚  INSERT INTO messages (                          â”‚
         â”‚    chat_id, role, content, sequence_number      â”‚
         â”‚  ) VALUES (                                      â”‚
         â”‚    '550e8400-...', 'user',                      â”‚
         â”‚    'Build ESP32 weather station...', 1          â”‚
         â”‚  );                                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ORCHESTRATOR AGENT                              â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
         â”‚  API: POST /api/chat                            â”‚
         â”‚  - Reads message from DB                         â”‚
         â”‚  - Calls openai/gpt-4o                          â”‚
         â”‚  - Returns: intent = "CHAT"                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  CONVERSATIONAL AGENT                            â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚
         â”‚  API: POST /api/agents/conversational           â”‚
         â”‚  - Calls anthropic/claude-opus-4-5              â”‚
         â”‚  - Response: "Great! What's your goal?"         â”‚
         â”‚                                                   â”‚
         â”‚  INSERT INTO messages (                          â”‚
         â”‚    chat_id, role, content,                      â”‚
         â”‚    agent_name, agent_model, intent,             â”‚
         â”‚    input_tokens, output_tokens                  â”‚
         â”‚  ) VALUES (                                      â”‚
         â”‚    '550e8400-...', 'assistant',                 â”‚
         â”‚    'Great! What is your goal?...',              â”‚
         â”‚    'conversational',                            â”‚
         â”‚    'anthropic/claude-opus-4-5',                 â”‚
         â”‚    'CHAT', 1250, 180                            â”‚
         â”‚  );                                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ... User answers questions ...                 â”‚
         â”‚  Goal: Monitor temperature                      â”‚
         â”‚  Location: Greenhouse                           â”‚
         â”‚  Budget: $50                                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  User: "Generate BOM"                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ORCHESTRATOR â†’ intent = "BOM"                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  BOM GENERATOR AGENT                                     â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
         â”‚  API: POST /api/agents/bom                              â”‚
         â”‚  - Calls openai/o1 (elite reasoning)                    â”‚
         â”‚  - Returns: BOM with parts list                         â”‚
         â”‚                                                          â”‚
         â”‚  1. CREATE PROJECT                                       â”‚
         â”‚  INSERT INTO projects (user_id, name, goal...)          â”‚
         â”‚  VALUES ('user-123', 'Greenhouse Monitor', ...)         â”‚
         â”‚  RETURNING id â†’ project_id = 'proj-abc'                â”‚
         â”‚                                                          â”‚
         â”‚  2. LINK CHAT TO PROJECT                                â”‚
         â”‚  UPDATE chats SET project_id = 'proj-abc'               â”‚
         â”‚  WHERE id = '550e8400-...'                             â”‚
         â”‚                                                          â”‚
         â”‚  3. CREATE BOM ARTIFACT                                 â”‚
         â”‚  SELECT create_artifact_with_version(                   â”‚
         â”‚    '550e8400-...', -- chat_id                          â”‚
         â”‚    'proj-abc',     -- project_id                       â”‚
         â”‚    'bom',          -- type                             â”‚
         â”‚    'Greenhouse Monitor BOM', -- title                  â”‚
         â”‚    NULL,           -- content (text)                   â”‚
         â”‚    '{"components": [...]}', -- content_json            â”‚
         â”‚    message_id                                           â”‚
         â”‚  ) â†’ Returns artifact_id = 'art-123'                   â”‚
         â”‚                                                          â”‚
         â”‚  4. INSERT PARTS                                        â”‚
         â”‚  INSERT INTO parts (project_id, artifact_id, ...)      â”‚
         â”‚  VALUES                                                 â”‚
         â”‚    ('proj-abc', 'art-123', 'ESP32-DevKitC', ...),     â”‚
         â”‚    ('proj-abc', 'art-123', 'BME280', ...),            â”‚
         â”‚    ('proj-abc', 'art-123', '0.96" OLED', ...);        â”‚
         â”‚                                                          â”‚
         â”‚  5. STORE ASSISTANT MESSAGE                            â”‚
         â”‚  INSERT INTO messages (                                 â”‚
         â”‚    chat_id, role, content,                             â”‚
         â”‚    agent_name, created_artifact_ids                    â”‚
         â”‚  ) VALUES (                                             â”‚
         â”‚    '550e8400-...', 'assistant',                        â”‚
         â”‚    'I've created your BOM...',                         â”‚
         â”‚    'bomGenerator', '{art-123}'                         â”‚
         â”‚  );                                                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  UI DISPLAYS BOM IN DRAWER                      â”‚
         â”‚  - Query artifact_versions for current version   â”‚
         â”‚  - Query parts for component list                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  User: "Replace DHT22 with BME280"              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  UPDATE BOM ARTIFACT                                     â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
         â”‚  1. UPDATE parts SET name = 'BME280'                    â”‚
         â”‚     WHERE name = 'DHT22' AND project_id = 'proj-abc'   â”‚
         â”‚                                                          â”‚
         â”‚  2. UPDATE artifacts                                     â”‚
         â”‚     SET current_version = 2, total_versions = 2         â”‚
         â”‚     WHERE id = 'art-123'                                â”‚
         â”‚                                                          â”‚
         â”‚  3. INSERT INTO artifact_versions (                     â”‚
         â”‚      artifact_id, version_number,                       â”‚
         â”‚      content_json, change_summary,                      â”‚
         â”‚      parent_version_id                                  â”‚
         â”‚    ) VALUES (                                            â”‚
         â”‚      'art-123', 2,                                      â”‚
         â”‚      '{"components": [BME280...]}',                     â”‚
         â”‚      'Replaced DHT22 with BME280',                      â”‚
         â”‚      version_1_id                                       â”‚
         â”‚    );                                                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  User: "Generate wiring diagram"                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  WIRING SPECIALIST AGENT                                â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚
         â”‚  1. CREATE WIRING ARTIFACT                              â”‚
         â”‚  2. INSERT CONNECTIONS (pin-to-pin)                     â”‚
         â”‚     INSERT INTO connections (                            â”‚
         â”‚       project_id, from_part_id, from_pin,              â”‚
         â”‚       to_part_id, to_pin, wire_color, voltage          â”‚
         â”‚     ) VALUES                                             â”‚
         â”‚       ('proj-abc', esp32_id, 'GPIO21',                 â”‚
         â”‚        bme280_id, 'SDA', 'Yellow', '3.3V'),            â”‚
         â”‚       ('proj-abc', esp32_id, 'GPIO22',                 â”‚
         â”‚        bme280_id, 'SCL', 'Green', '3.3V'),             â”‚
         â”‚       ...;                                               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  User: "Generate code"                          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  CODE GENERATOR AGENT                                   â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
         â”‚  1. CREATE CODE ARTIFACT                                â”‚
         â”‚  2. INSERT CODE_FILES                                   â”‚
         â”‚     INSERT INTO code_files (                            â”‚
         â”‚       project_id, artifact_id,                          â”‚
         â”‚       filename, language, content,                      â”‚
         â”‚       unit_number, unit_type                            â”‚
         â”‚     ) VALUES                                             â”‚
         â”‚       ('proj-abc', 'code-art-456',                     â”‚
         â”‚        'calibration.ino', 'cpp',                        â”‚
         â”‚        'void setup() {...}', 1, 'calibration'),        â”‚
         â”‚       ('proj-abc', 'code-art-456',                     â”‚
         â”‚        'full_implementation.ino', 'cpp',                â”‚
         â”‚        'void setup() {...}', 2, 'full');               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  User uploads circuit photo                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  CIRCUIT VERIFIER AGENT                                 â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
         â”‚  1. STORE IN SUPABASE STORAGE                           â”‚
         â”‚     const { data } = await supabase.storage            â”‚
         â”‚       .from('attachments')                              â”‚
         â”‚       .upload('user-123/chat-550e/circuit.jpg', file)  â”‚
         â”‚                                                          â”‚
         â”‚  2. CREATE ATTACHMENT RECORD                            â”‚
         â”‚     INSERT INTO attachments (                            â”‚
         â”‚       chat_id, message_id, filename,                   â”‚
         â”‚       storage_path, category                            â”‚
         â”‚     ) VALUES (...);                                      â”‚
         â”‚                                                          â”‚
         â”‚  3. ANALYZE WITH GEMINI VISION                          â”‚
         â”‚     - Send image to google/gemini-2.5-flash            â”‚
         â”‚                                                          â”‚
         â”‚  4. STORE VERIFICATION RESULT                           â”‚
         â”‚     INSERT INTO circuit_verifications (                 â”‚
         â”‚       chat_id, project_id, image_url,                  â”‚
         â”‚       status, components_detected,                      â”‚
         â”‚       issues, suggestions                               â”‚
         â”‚     ) VALUES (                                           â”‚
         â”‚       '550e8400-...', 'proj-abc',                      â”‚
         â”‚       'storage-url', 'WARNING',                         â”‚
         â”‚       '[{"name": "ESP32", "detected": true}]',         â”‚
         â”‚       '["Wire on wrong pin"]',                         â”‚
         â”‚       '["Move yellow wire to GPIO21"]'                 â”‚
         â”‚     );                                                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SHARING WORKFLOW                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  User clicks "Share Chat"                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  CREATE SHARE LINK                              â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
         â”‚  INSERT INTO shared_chats (                     â”‚
         â”‚    chat_id, share_token                         â”‚
         â”‚  ) VALUES (                                      â”‚
         â”‚    '550e8400-...', 'abc123xyz'                 â”‚
         â”‚  );                                              â”‚
         â”‚                                                  â”‚
         â”‚  UPDATE chats                                   â”‚
         â”‚  SET is_public = true, share_token = 'abc123'  â”‚
         â”‚  WHERE id = '550e8400-...'                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Share URL: ohm.app/share/abc123xyz            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Another user visits link                       â”‚
         â”‚  - RLS allows SELECT (chat is public)           â”‚
         â”‚  - Can view all messages, artifacts             â”‚
         â”‚  - Can click "Fork this chat"                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Example Queries for Common Operations

### 1. Load Chat Page

```sql
-- Single query to load everything
SELECT 
  c.*,
  json_agg(
    DISTINCT jsonb_build_object(
      'id', m.id,
      'role', m.role,
      'content', m.content,
      'agent_name', m.agent_name,
      'created_at', m.created_at
    ) ORDER BY m.sequence_number
  ) as messages,
  json_agg(
    DISTINCT jsonb_build_object(
      'id', a.id,
      'type', a.type,
      'title', a.title,
      'current_version', a.current_version
    )
  ) FILTER (WHERE a.id IS NOT NULL) as artifacts,
  p.name as project_name
FROM chats c
LEFT JOIN messages m ON m.chat_id = c.id
LEFT JOIN artifacts a ON a.chat_id = c.id
LEFT JOIN projects p ON p.id = c.project_id
WHERE c.id = '550e8400-...'
GROUP BY c.id, p.name;
```

### 2. Get BOM with Parts

```sql
-- Get current BOM version with all parts
SELECT 
  a.title,
  av.version_number,
  av.change_summary,
  json_agg(
    jsonb_build_object(
      'name', pt.name,
      'partNumber', pt.part_number,
      'voltage', pt.voltage,
      'price', pt.price,
      'supplier', pt.supplier
    )
  ) as parts
FROM artifacts a
JOIN artifact_versions av ON av.artifact_id = a.id 
  AND av.version_number = a.current_version
JOIN parts pt ON pt.artifact_id = a.id
WHERE a.id = 'art-123'
GROUP BY a.id, a.title, av.version_number, av.change_summary;
```

### 3. Get Wiring Instructions

```sql
-- Step-by-step wiring guide
SELECT 
  c.sequence_number as step,
  p1.name || ' ' || c.from_pin as from,
  p2.name || ' ' || c.to_pin as to,
  c.wire_color,
  c.voltage,
  c.notes
FROM connections c
JOIN parts p1 ON p1.id = c.from_part_id
JOIN parts p2 ON p2.id = c.to_part_id
WHERE c.project_id = 'proj-abc'
ORDER BY c.sequence_number;
```

### 4. Search All Chats

```sql
-- Full-text search
SELECT 
  c.id,
  c.title,
  LEFT(m.content, 100) as preview,
  ts_rank(m.content_search, query) as rank
FROM chats c
JOIN messages m ON m.chat_id = c.id
CROSS JOIN websearch_to_tsquery('english', 'ESP32 weather') as query
WHERE 
  c.user_id = 'user-123'
  AND m.content_search @@ query
ORDER BY rank DESC, c.last_message_at DESC
LIMIT 10;
```

### 5. Get Chat Cost

```sql
-- Calculate total cost for a chat
SELECT 
  c.title,
  COUNT(m.id) as total_messages,
  SUM(m.input_tokens + m.output_tokens) as total_tokens,
  (SUM(m.input_tokens + m.output_tokens) / 1000.0) * 0.01 as estimated_cost_usd
FROM chats c
JOIN messages m ON m.chat_id = c.id
WHERE c.id = '550e8400-...'
GROUP BY c.id, c.title;
```

---

## ğŸ” Row-Level Security Examples

### Policy: Users can only see their own chats or public chats

```sql
CREATE POLICY "users_view_accessible_chats" ON chats
FOR SELECT USING (
  -- User owns the chat
  auth.uid() = user_id
  OR
  -- Chat is public
  is_public = true
  OR
  -- Chat has been shared
  id IN (SELECT chat_id FROM shared_chats)
);
```

### Policy: Users can only create messages in their own chats

```sql
CREATE POLICY "users_insert_messages_own_chats" ON messages
FOR INSERT WITH CHECK (
  chat_id IN (
    SELECT id FROM chats WHERE user_id = auth.uid()
  )
);
```

---

## ğŸ“ˆ Scaling Considerations

### When You Hit 100K+ Messages

1. **Partition by Month**:
```sql
CREATE TABLE messages_2026_01 PARTITION OF messages
FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
```

2. **Archive Old Chats**:
```sql
-- Move chats older than 1 year to archive table
INSERT INTO chats_archive 
SELECT * FROM chats 
WHERE last_message_at < NOW() - INTERVAL '1 year';
```

3. **Add Materialized Views**:
```sql
CREATE MATERIALIZED VIEW recent_chats_summary AS
SELECT 
  c.id,
  c.title,
  COUNT(m.id) as message_count,
  MAX(m.created_at) as last_message
FROM chats c
LEFT JOIN messages m ON m.chat_id = c.id
GROUP BY c.id
ORDER BY last_message DESC
LIMIT 1000;

REFRESH MATERIALIZED VIEW recent_chats_summary;
```

---

## ğŸ‰ Summary

This visual guide shows:

âœ… **Complete ERD** - All tables and relationships  
âœ… **Data Flow** - Step-by-step from user action to database  
âœ… **Example Queries** - Real SQL for common operations  
âœ… **RLS Policies** - Security at database level  
âœ… **Scaling Strategies** - Ready for growth  

**Your database is production-ready!** ğŸš€

